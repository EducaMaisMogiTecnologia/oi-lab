#!/bin/bash
###########################################################################
# Updates BusID entries in passed xorg.conf files according to a given
# pattern to be searched in 'lspci' output.
#
# Usage: oi-lab-update-xorg-conf PCI-ADDRESS
###########################################################################
pci_format () {
    echo ${1//[.:]/${2}}
}

address=${1}
seat_address=$(pci_format ${address} -)
xorg_address=$(pci_format ${address} :)
xorg_conf_dir=/etc/X11/xorg.conf.d
xorg_conf=${xorg_conf_dir}/21-oi-lab-sm501-${seat_address}.conf
[[ -d ${xorg_conf_dir} ]] || mkdir -p ${xorg_conf_dir}

cat > ${xorg_conf}.new << EOF
Section "Device"
    MatchSeat "__fake-seat-${seat_address}__"
    Identifier "Silicon Motion SM501 Video Card ${seat_address}"
    BusID "PCI:${xorg_address}"
    Driver "siliconmotion"
    Option "PanelSize" "1360x768"
    Option "Dualhead" "true"
    Option "monitor-LVDS" "Left Monitor"
    Option "monitor-VGA" "Right Monitor"
EndSection

Section "Screen"
    MatchSeat "__fake-seat-${seat_address}__"
    Identifier "Silicon Motion SM501 Screen ${seat_address}"
    Device "Silicon Motion SM501 Video Card ${seat_address}"
    DefaultDepth 16
EndSection
EOF

if [[ -f ${xorg_conf} ]]
then
    # Update ${xorg_conf} timestamp if, and only if,
    # its contents have changed.
    patch -p0 ${xorg_conf} <(diff -u ${xorg_conf} ${xorg_conf}.new)
    rm -f ${xorg_conf}.new
else
    mv ${xorg_conf}.new ${xorg_conf}
fi