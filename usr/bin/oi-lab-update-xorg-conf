#!/bin/bash
###########################################################################
# Updates BusID entries in passed xorg.conf files according to a given
# pattern to be searched in 'lspci' output.
#
# Usage: oi-lab-update-xorg-conf PCI-ADDRESS XORGCONF_IN
###########################################################################
pci_format () {
    echo ${1//[.:]/${2}}
}

address=${1}
xorgconf_stub=${2}
xorgconf=$(basename ${xorgconf_stub%.in})
seat_address=$(pci_format ${address} -)
xorg_address=$(pci_format ${address} :)
rundir=/run/X11/xorg.conf.d
[ -d ${rundir} ] || mkdir -p ${rundir}

sed \
-e "s/[0-9]\+:[0-9]\+:[0-9]\+/${xorg_address}/" \
-e "s/@SM501_PCI_ADDRESS@/${seat_address}/g" \
${xorgconf_in} > ${rundir}/${xorgconf/xx/${seat_address}}